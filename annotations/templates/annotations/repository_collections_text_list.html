{% extends "annotations/base.html" %}
{% load staticfiles %}

{% block breadcrumbs %}
<a href="{% url "home" %}" class="btn btn-xs">Home</a>&raquo;
<a href="{% url "repository_list" %}{% if project_id %}?project_id={{ project_id }}{% endif %}" class="btn btn-xs">Repositories</a>&raquo;
<a href="{% url "repository_details" repository.id %}{% if project_id %}?project_id={{ project_id }}{% endif %}" class="btn btn-xs">{{ repository.name }}</a>&raquo;
<a href="{% url "repository_collections" repository.id %}{% if project_id %}?project_id={{ project_id }}{% endif %}" class="btn btn-xs">Collections</a>&raquo;
<a href="{% url "repository_collection" repository.id group_id %}{% if project_id %}?project_id={{ project_id }}{% endif %}" class="btn btn-xs">{{ group_info.name }}</a>
{% endblock %}

{% block main %}
<div class="container">
    <h1>{{ title }}{{ group_info.name }}</h1><br>
    <table class="table table-striped">
        <thead class="thead-dark">
            <tr>
                <th>Title</th>
                <th>Authors</th>
                <th>Item Type</th>
                <th>Volume</th>
                <th>Pages</th>
                <th>URL</th>
                <th>Date Added</th>
                <th>Files</th>
                <th>Actions</th>
            </tr>
        </thead>
        <tbody>
            {% for text in texts %}
            <tr>
                <td>{{ text.title }}</td>
                <td>
                    {% for author in text.authors %}
                        {% if author.firstName and author.lastName %}
                            {{ author.firstName }} {{ author.lastName }}
                        {% else %}
                            {{ author.name }}
                        {% endif %}
                        {% if not forloop.last %}, {% endif %}
                    {% empty %}
                        No authors listed
                    {% endfor %}
                </td>
                <td>{{ text.itemType }}</td>
                <td>{{ text.volume|default:"N/A" }}</td>
                <td>{{ text.pages|default:"N/A" }}</td>
                <td>{{ text.url|default:"N/A" }}</td>
                <td>{{ text.dateAdded }}</td>
                <td>
                    {% if text.gilesUploads and text.gilesUploads|length > 0 %}
                    <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" class="bi bi-file-earmark" viewBox="0 0 16 16">
                        <path d="M14 4.5V14a2 2 0 0 1-2 2H4a2 2 0 0 1-2-2V2a2 2 0 0 1 2-2h5.5zm-3 0A1.5 1.5 0 0 1 9.5 3V1H4a1 1 0 0 0-1 1v12a1 1 0 0 0 1 1h8a1 1 0 0 0 1-1V4.5z"/>
                    </svg>{% else %}{% endif %}
                </td>
                <td>
                    <button class="btn btn-primary btn-sm" onclick="fetchFiles('{{ text.key }}')">
                        View Files
                    </button>
                </td>
            </tr>
            <tr id="file-row-{{ text.key }}" style="display: none;">
                <td colspan="9">
                    <div class="file-list" id="file-list-{{ text.key }}"></div>
                </td>
            </tr>
            {% empty %}
            <tr>
                <td colspan="9" class="text-center">No texts available in this collection.</td>
            </tr>
            {% endfor %}
        </tbody>
    </table>
</div>

<script>
    function fetchFiles(itemKey) {
        const fileListDiv = document.getElementById(`file-list-${itemKey}`);
        const fileRow = document.getElementById(`file-row-${itemKey}`);
        console.log("Fetching files for itemKey:", itemKey);

        // Clear any existing file information
        fileListDiv.innerHTML = 'Loading files...';
        fileRow.style.display = 'table-row';

        const repositoryId = {{ repository.id }};
        const groupId = {{ group_id }};
        const url = `/repository/files/${repositoryId}/groups/${groupId}/items/${itemKey}/`;

        fetch(url, {
            method: 'GET',
            headers: {
                'X-CSRFToken': '{{ csrf_token }}'
            }
        })
        .then(response => response.json())
        .then(data => {
            console.log(data);

            // Display files
            if (data.files && data.files.length > 0) {
                let fileListHtml = '<ul class="list-group">';
                data.files.forEach(file => {
                    fileListHtml += `<li class="list-group-item d-flex justify-content-between align-items-center">
                        <span class="file-name">${file.filename}</span>
                        <button class="btn btn-info btn-sm import-file" data-file-url="${file.url}" data-item-key="${itemKey}">
                            <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" fill="currentColor" class="bi bi-cloud-arrow-down" viewBox="0 0 16 16">
                            <path fill-rule="evenodd" d="M7.646 10.854a.5.5 0 0 0 .708 0l2-2a.5.5 0 0 0-.708-.708L8.5 9.293V5.5a.5.5 0 0 0-1 0v3.793L6.354 8.146a.5.5 0 1 0-.708.708z"/>
                            <path d="M4.406 3.342A5.53 5.53 0 0 1 8 2c2.69 0 4.923 2 5.166 4.579C14.758 6.804 16 8.137 16 9.773 16 11.569 14.502 13 12.687 13H3.781C1.708 13 0 11.366 0 9.318c0-1.763 1.266-3.223 2.942-3.593.143-.863.698-1.723 1.464-2.383m.653.757c-.757.653-1.153 1.44-1.153 2.056v.448l-.445.049C2.064 6.805 1 7.952 1 9.318 1 10.785 2.23 12 3.781 12h8.906C13.98 12 15 10.988 15 9.773c0-1.216-1.02-2.228-2.313-2.228h-.5v-.5C12.188 4.825 10.328 3 8 3a4.53 4.53 0 0 0-2.941 1.1z"/>
                            </svg>
                        </button>
                    </li>`;
                });
                fileListHtml += '</ul>';
                fileListDiv.innerHTML = fileListHtml;
            } else {
                fileListDiv.innerHTML = '<div class="alert alert-warning">No files available for this item.</div>';
            }
        })
        .catch(error => {
            console.error('Error fetching files:', error);
            fileListDiv.innerHTML = '<div class="alert alert-danger">Failed to load files.</div>';
        });
    }
</script>

{% endblock %}
